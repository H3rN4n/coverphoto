/*! Cover Photo - v0.1.0 - 2012-10-05
* https://github.com/sandropadin/coverphoto
* Copyright (c) 2012 Sandro Padin; Licensed MIT */
this.coverphotoTemplates=this.coverphotoTemplates||{},this.coverphotoTemplates["src/templates/actions.jst"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="actions">\n  <ul class="chooser">\n    <li class="open-menu item"><a href="#change_cover_photo">Change cover photo</a></li>\n    <ul class="menu">\n      <li class="upload item"><a href="#upload_cover_photo">Upload new photo</a></li>\n      <!-- <li class="reposition item"><a href="#reposition_cover_photo">Reposition current photo</a></li> -->\n    </ul>\n  </ul>\n  <ul class="edit">\n    <li class="cancel item"><a href="#cancel">Cancel</a></li>\n    <li class="save item"><a href="#save">Save</a></li>\n  </ul>\n</div>';return __p},this.coverphotoTemplates["src/templates/container.jst"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class=\"coverphoto-container\">\n  <canvas class='output'>\n</div>";return __p},this.coverphotoTemplates["src/templates/form.jst"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<form action="'+postUrl+'" class="coverphoto-form" method="post" enctype="multipart/form-data">\n  <input type="file" name="coverphoto[original]" accept="image/*">\n  <input type="hidden" name="coverphoto[cropped]">\n</form>';return __p},this.coverphotoTemplates["src/templates/image.jst"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="coverphoto-photo-container">\n  <img src="'+imageData+'" width="1024">\n</div>';return __p},function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};(function(t){var n;return n=function(){function n(t){this.el=t.el,this.options=t.options,this.handleFileSelected=e(this.handleFileSelected,this),this.endReposition=e(this.endReposition,this),this.startReposition=e(this.startReposition,this),this.cancelEdit=e(this.cancelEdit,this),this.saveEdit=e(this.saveEdit,this),this.startUpload=e(this.startUpload,this),this.hideEditMenu=e(this.hideEditMenu,this),this.showEditMenu=e(this.showEditMenu,this),this.hideActionsMenu=e(this.hideActionsMenu,this),this.showActionsMenu=e(this.showActionsMenu,this),this.showActions=e(this.showActions,this),this.hideActions=e(this.hideActions,this),this.templates=coverphotoTemplates,this.setup(),this.cache(),this.render(),this.elements(),this.bindEvents()}return n.cache=[],n.cacheCount=0,n.defaults={postUrl:"/update_cover_photo",editable:!1},n.prototype.render=function(){return this.addForm(),this.options.editable&&this.addActions(),this.options.currentImage&&this.addImage(this.options.currentImage),t("canvas",this.$el).attr("width",this.$el.width()),t("canvas",this.$el).attr("height",this.$el.height())},n.prototype.bindEvents=function(){return t(this.$el).on("mouseleave",this.hideActions),t(this.$el).on("mouseenter",this.showActions),t(this.$el).on("mouseleave",this.actionsContainer.selector,this.hideActionsMenu),t(this.$el).on("change",this.fileInput.selector,this.handleFileSelected),t(this.$el).on("click",this.openMenuButton.selector,this.showActionsMenu),t(this.$el).on("click",this.uploadButton.selector,this.startUpload),t(this.$el).on("click",this.repositionButton.selector,this.startReposition),t(this.$el).on("click",this.saveEditButton.selector,this.saveEdit),t(this.$el).on("click",this.cancelEditButton.selector,this.cancelEdit)},n.prototype.setup=function(){var e;return this.options=t.extend(n.defaults,this.options),e=this.templates["src/templates/container.jst"](),this.$el=t(e).appendTo(t(this.el))},n.prototype.cache=function(){return this.$el.attr("data-coverphoto-id",n.cacheCount),n.cache[n.cacheCount]=this,n.cacheCount++},n.prototype.elements=function(){return this.actionsContainer=t(".actions",this.$el),this.actions=t(".chooser",this.$el),this.actionsMenu=t(".chooser .menu",this.$el),this.editMenu=t(".edit",this.$el),this.cancelEditButton=t(".edit .cancel a",this.$el),this.saveEditButton=t(".edit .save a",this.$el),this.openMenuButton=t(".chooser .open-menu a",this.$el),this.uploadButton=t(".chooser .upload a",this.$el),this.repositionButton=t(".chooser .reposition a",this.$el),this.form=t("form",this.$el),this.fileInput=t("input[name='coverphoto[original]']",this.$el),this.hiddenImageInput=t("input[name='coverphoto[cropped]']",this.$el),this.canvas=t("canvas",this.$el)},n.prototype.addForm=function(){return this.$el.append(this.templates["src/templates/form.jst"](this.options))},n.prototype.addActions=function(){return this.$el.append(this.templates["src/templates/actions.jst"](this.options))},n.prototype.addImage=function(e){return this.originalImage=t(".coverphoto-photo-container img",this.$el).attr("src"),t(".coverphoto-photo-container",this.$el).remove(),this.$el.append(this.templates["src/templates/image.jst"]({imageData:e}))},n.prototype.hideActions=function(){return this.actions.fadeOut()},n.prototype.showActions=function(){if(!this.editMenu.is(":visible"))return this.actions.fadeIn()},n.prototype.showActionsMenu=function(){return this.actionsMenu.show(),!1},n.prototype.hideActionsMenu=function(e){return this.actionsMenu.hide()},n.prototype.showEditMenu=function(){return this.editMenu.show(),this.actions.hide()},n.prototype.hideEditMenu=function(){return this.editMenu.hide(),this.actions.show()},n.prototype.startUpload=function(){return this.fileInput.click(),!1},n.prototype.saveEdit=function(){return console.log("Saving to "+this.options.postUrl),this.gatherImageData(),this.form.submit(),this.hideEditMenu(),this.endReposition(),!1},n.prototype.cancelEdit=function(){return this.originalImage&&this.addImage(this.originalImage),this.hideEditMenu(),this.endReposition(),!1},n.prototype.startReposition=function(e){var n,r,i=this;return e==null&&(e=null),n=t(".coverphoto-photo-container img",this.$el),r=function(){var e;return e=-(n.height()-n.parent().height()-10),n.draggable({axis:"y",containment:[0,e,0,0]})},n.height()>0?r():n.load(r),this.showEditMenu(),e!=null&&this.hideActionsMenu(),!1},n.prototype.endReposition=function(){var e;return e=t(".coverphoto-photo-container img",this.$el),e.draggable("destroy")},n.prototype.handleFileSelected=function(e){var t,n,r=this;return t=e.target.files[0],n=new FileReader,n.onload=function(e){return r.addImage(e.target.result),r.startReposition()},n.readAsDataURL(t)},n.prototype.gatherImageData=function(){var e,n,r,i,s;return i=t(".coverphoto-photo-container img",this.$el),e=this.canvas[0].getContext("2d"),s=i.width(),r=i.height(),e.drawImage(i[0],0,i.position().top,s,r),n=this.canvas[0].toDataURL("image/png"),this.hiddenImageInput.val(n)},n}(),t.fn.CoverPhoto=function(e){return e==="get"&&this.length===1?n.cache[t(this).data("coverphoto-id")]:this.each(function(){return new n({el:this,options:e})})}})($)}.call(this);